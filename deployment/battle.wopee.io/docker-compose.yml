services:
  postgresql:
    image: postgres:18-alpine
    container_name: authentik-db
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}"]
      start_period: 20s
      interval: 10s
      retries: 5
      timeout: 5s
    volumes:
      - authentik-db:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      - POSTGRES_USER=${AUTHENTIK_POSTGRESQL__USER}
      - POSTGRES_DB=${AUTHENTIK_POSTGRESQL__NAME}
    networks:
      - default

  authentik-server:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_TAG}
    container_name: authentik-server
    restart: unless-stopped
    command: server
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_POSTGRESQL__HOST=postgresql
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRESQL__USER}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRESQL__NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      # Bootstrap
      - AUTHENTIK_BOOTSTRAP_EMAIL=${AUTHENTIK_BOOTSTRAP_EMAIL}
      - AUTHENTIK_BOOTSTRAP_PASSWORD=${AUTHENTIK_BOOTSTRAP_PASSWORD}
      - AUTHENTIK_BOOTSTRAP_TOKEN=${AUTHENTIK_BOOTSTRAP_TOKEN}
      # URLs
      - AUTHENTIK_HOST=https://${AUTHENTIK_DOMAIN}
      - AUTHENTIK_HOST_BROWSER=https://${AUTHENTIK_DOMAIN}
      # Cookie Hardening
      - AUTHENTIK_COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - AUTHENTIK_SESSION_COOKIE_SAMESITE=none
      - AUTHENTIK_SESSION_COOKIE_SECURE=true
      - AUTHENTIK_PROXY_COOKIE_SAMESITE=none
      - AUTHENTIK_PROXY_COOKIE_SECURE=true
      - AUTHENTIK_OUTPOSTS__PROXY__COOKIE__SAMESITE=none
      - AUTHENTIK_OUTPOSTS__PROXY__COOKIE__SECURE=true
      # Logging
      - AUTHENTIK_LOG_LEVEL=info
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_DISABLE_STARTUP_ANALYTICS=true
    volumes:
      - authentik-media:/media
      - ./blueprints:/blueprints/default/custom
    networks:
      - default
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.authentik.rule=Host(`${AUTHENTIK_DOMAIN}`)
      - traefik.http.routers.authentik.entrypoints=websecure
      - traefik.http.routers.authentik.tls.certresolver=letsencrypt
      - traefik.http.services.authentik.loadbalancer.server.port=9000

  authentik-worker:
    image: ghcr.io/goauthentik/server:${AUTHENTIK_TAG}
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    depends_on:
      postgresql:
        condition: service_healthy
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_POSTGRESQL__HOST=postgresql
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRESQL__USER}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRESQL__NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      # Logging
      - AUTHENTIK_LOG_LEVEL=info
      - AUTHENTIK_ERROR_REPORTING__ENABLED=false
      - AUTHENTIK_DISABLE_STARTUP_ANALYTICS=true
      # Blueprint Environment Variables
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - APP_DOMAIN=${APP_DOMAIN}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      # Cookie Hardening
      - AUTHENTIK_COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - AUTHENTIK_SESSION_COOKIE_SAMESITE=none
      - AUTHENTIK_SESSION_COOKIE_SECURE=true
      - AUTHENTIK_PROXY_COOKIE_SAMESITE=none
      - AUTHENTIK_PROXY_COOKIE_SECURE=true
      - AUTHENTIK_OUTPOSTS__PROXY__COOKIE__SAMESITE=none
      - AUTHENTIK_OUTPOSTS__PROXY__COOKIE__SECURE=true
    volumes:
      - authentik-media:/media
      - ./blueprints:/blueprints/default/custom
    networks:
      - default
    user: root

  authentik-bootstrap:
    build:
      context: ./bootstrap
      dockerfile: Dockerfile
    container_name: authentik-bootstrap
    restart: "no"
    depends_on:
      postgresql:
        condition: service_healthy
      authentik-server:
        condition: service_healthy
      authentik-worker:
        condition: service_healthy
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_POSTGRESQL__HOST=postgresql
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRESQL__USER}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRESQL__NAME}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      - AUTHENTIK_DOMAIN=${AUTHENTIK_DOMAIN}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - APP_DOMAIN=${APP_DOMAIN}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
    networks:
      - default

  spawner:
    build:
      context: ./spawner
      dockerfile: Dockerfile
    container_name: spawner
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/spawner-env:/tmp/spawner-env
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DEFAULT_IMAGE=${SPAWNER_IMAGE}
      - DOMAIN=${DOMAIN}
      - NETWORK=proxy
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN}
    networks:
      - default
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.studio.rule=Host(`${APP_DOMAIN}`)
      - traefik.http.routers.studio.entrypoints=websecure
      - traefik.http.routers.studio.tls.certresolver=letsencrypt
      - traefik.http.routers.studio.middlewares=authentik-auth
      - traefik.http.services.spawner-svc.loadbalancer.server.port=8080
      # ForwardAuth Middleware
      - traefik.http.middlewares.authentik-auth.forwardauth.address=http://authentik-server:9000/outpost.goauthentik.io/auth/traefik
      - traefik.http.middlewares.authentik-auth.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.authentik-auth.forwardauth.authResponseHeaders=X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version

volumes:
  authentik-db:
    driver: local
  authentik-media:
    driver: local

networks:
  default:
    name: proxy
    external: true
